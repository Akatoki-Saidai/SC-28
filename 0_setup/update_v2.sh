#!/bin/bash

# ==========================================
# 設定エリア
# ==========================================
PROJECT_DIR="/home/sc28/SC-28"

# ------------------------------------------
# エラーハンドリング関数
# ------------------------------------------
handle_error() {
    echo ""
    echo "❌ エラーが発生しました: $1"
    echo "ウィンドウを閉じずに待機します..."
    exec bash
}

# ------------------------------------------
# メイン処理
# ------------------------------------------

# 1. プロジェクトへ移動
cd "$PROJECT_DIR" || handle_error "フォルダが見つかりません ($PROJECT_DIR)"

echo "-----------------------------------"
echo "GitHubから最新を取得中..."
echo "-----------------------------------"

# 2. Pull実行（FetchはPullに含まれるので削除）
# 失敗時はエラー関数を呼ぶ
git pull origin main || handle_error "Pullに失敗しました（ネット接続などを確認してください）"

echo "-----------------------------------"
echo "仮想環境を有効化中..."
echo "-----------------------------------"

# 3. 仮想環境のチェックと有効化
if [ ! -f ".venv/bin/activate" ]; then
    handle_error "仮想環境(.venv)が見つかりません。作成済みか確認してください。"
fi

source .venv/bin/activate || handle_error "仮想環境の有効化に失敗しました"

echo "-----------------------------------"
echo "✅ 完了！仮想環境に入りました。"
echo "-----------------------------------"

# 4. シェルを維持
# 普通に exec bash すると (.venv) 表記が消えてしまうため、
# 明示的に「設定を読み込んでからactivateした状態で」起動させるおまじない
exec bash --rcfile <(echo '. ~/.bashrc; source .venv/bin/activate')