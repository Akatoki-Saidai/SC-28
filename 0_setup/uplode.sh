#!/bin/bash

# ==========================================
# 設定エリア
# ==========================================
# 1. パスの設定（フィードバック反映：絶対パスで結合して安全性を向上）
PROJECT_DIR="/home/sc28/SC-28"   # プロジェクトのルート
DATA_DIR="${PROJECT_DIR}/5_log"  # CSV保存フォルダ（絶対パスになる）
COMMIT_MSG="Auto-upload: Log data"
# ==========================================

# ------------------------------------------
# 関数：エラー時にメッセージを出してウィンドウを残す
# ------------------------------------------
handle_error() {
    echo ""
    echo "❌ エラーが発生しました: $1"
    echo "ウィンドウを閉じずに待機します..."
    exec bash
}

# ------------------------------------------
# メイン処理
# ------------------------------------------

# 2. フォルダ存在チェック（フィードバック反映）
if [ ! -d "$DATA_DIR" ]; then
    handle_error "データフォルダが見つかりません ($DATA_DIR)"
fi

# プロジェクトへ移動
cd "$PROJECT_DIR" || handle_error "プロジェクトフォルダへの移動に失敗しました"

echo "-----------------------------------"
echo "GitHubへアップロードを開始します"
echo "-----------------------------------"

# データを追加
git add "$DATA_DIR"

# 変更があるか確認
if git diff --cached --quiet; then
    echo "新しいデータはありませんでした。"
    echo "3秒後にウィンドウを閉じます..."
    sleep 3
    exit 0
fi

# 3. コミット実行（失敗したら止める）
echo "コミット中..."
git commit -m "$COMMIT_MSG" || handle_error "コミットに失敗しました"

# 4. プッシュ実行（フィードバック反映：失敗を検知する）
echo "GitHubへ送信中..."
if git push origin main; then
    echo "-----------------------------------"
    echo "✅ アップロード完了！"
    echo "-----------------------------------"
    echo "5秒後に自動的に閉じます..."
    sleep 5
    # ここでスクリプトが終了＝ウィンドウが閉じる
else
    # pushが失敗した場合
    handle_error "GitHubへのPushに失敗しました（ネット接続などを確認してください）"
fi